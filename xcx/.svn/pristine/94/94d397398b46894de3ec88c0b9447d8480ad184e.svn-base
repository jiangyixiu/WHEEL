//index.js
//获取应用实例
var app = getApp();
var util = require('../../utils/util.js');
Page({
  data:{
    order_list:false,
    AllOrder_id:'order_tap_show',
    NopayOrder_id:'',
    NoperfectOrder_id:'',
    show_order3:'0',
    show_order5:'0',
    show_order10:'0',
    list_data: {}
  },
  count_time:function(event){
    var that = this;
    var arr = this.data.list_data.data;
    var tempdata = this.data.list_data;
    var temp_dieindex = [];
    var temp_dietime = [];
    var temp_showdata = [];
    for(var i = 0 ;i<arr.length;i++){
      if(arr[i].paystats == '5'){
      temp_dieindex.push(i);
      temp_dietime.push(arr[i].dietime/1000);
      }
    }
    for(var j = 0 ; j < temp_dietime.length ; j++){
      var last_time = temp_dietime[j];
      var lastDay = Math.floor(last_time/(3600*24));
      var lastHour =  Math.floor((last_time - lastDay*3600*24)/3600);
      var lastMinute =  Math.floor((last_time - lastDay*3600*24 -lastHour * 3600)/60);
      if(lastMinute < 0){lastMinute = 0;}
      var lastSecond = Math.floor(last_time - lastDay*3600*24 - lastHour * 3600 - lastMinute*60);
      if(lastSecond < 0){lastSecond = 0;}
      if(lastSecond < 10) lastSecond = '0' + lastSecond;
      if(lastMinute < 10) lastMinute = '0' + lastMinute;
      if(lastHour < 10) lastHour = '0' + lastHour; 
      temp_showdata[j] = lastHour + ':' + lastMinute + ':' + lastSecond;
      temp_dietime[j] -= 1;
      tempdata.data[temp_dieindex[j]].dietime = temp_showdata[j];
    }
    this.setData({
      list_data:tempdata
    })
    setInterval(function(){
      for(var j = 0 ; j < temp_dietime.length ; j++){
        var last_time = temp_dietime[j];
        var lastDay = Math.floor(last_time/(3600*24));
        var lastHour =  Math.floor((last_time - lastDay*3600*24)/3600);
        var lastMinute =  Math.floor((last_time - lastDay*3600*24 -lastHour * 3600)/60);
        if(lastMinute < 0){lastMinute = 0;}
        var lastSecond = Math.floor(last_time - lastDay*3600*24 - lastHour * 3600 - lastMinute*60);
        if(lastSecond < 0){lastSecond = 0;}
        if(lastSecond < 10) lastSecond = '0' + lastSecond;
        if(lastMinute < 10) lastMinute = '0' + lastMinute;
        if(lastHour < 10) lastHour = '0' + lastHour; 
        temp_showdata[j] = lastHour + ':' + lastMinute + ':' + lastSecond;
        temp_dietime[j] -= 1;
        if(temp_dietime[j] <= 0){
          temp_dietime[j] = 0;
        } 
        tempdata.data[temp_dieindex[j]].dietime = temp_showdata[j];
      }
      that.setData({
        list_data:tempdata
      })
    },1000)
  },
  //事件处理函数
  taptoindex: function() {
   wx.redirectTo({
     url: '../userinfo/userinfo',
   })
  },
  all_order:function(){
    this.setData({
      AllOrder_id:'order_tap_show',
      NopayOrder_id:'',
      NoperfectOrder_id:'',
      show_order3:'0',
      show_order5:'0',
      show_order10:'0'
    })
  },
  nopay_order:function(){
    this.setData({
      AllOrder_id:'',
      NopayOrder_id:'order_tap_show',
      NoperfectOrder_id:'',
      show_order3:'1',
      show_order5:'10'
    })
  },
  noperfect_order:function(){
    this.setData({
      AllOrder_id:'',
      NopayOrder_id:'',
      NoperfectOrder_id:'order_tap_show',
      show_order3:'3',
      show_order5:'5',
      show_order10:'10'
    })
  },
  go_trip:function(event){
      console.log(event);
    var mealid = event.target.dataset.mealId;
    wx.navigateTo({
        url: '/pages/trip/trip?meal_id=' + mealid,
    })
  },
  re_sign:function(){
      console.log('重新报名');
  },
  onLoad: function () {
    var that = this;
    app.wx_request('https://api.h5.zx-tour.com/H5Order/getorderlist?uid=31390','post','json',{},that,function(res){
        if (res.data.data.length > 0) {
            that.setData({
                list_data: res.data
            })
            that.count_time();
        } else {
            that.setData({
                order_list: true
            })
        }
        console.log(that.data.list_data);
    })
    // console.log('onLoad')
    // var that = this
    // //调用应用实例的方法获取全局数据
    // app.getUserInfo(function(userInfo){
    //   //更新数据
    //   that.setData({
    //     userInfo:userInfo
    //   })
    // })
//   wx.request({
//   url: 'http://192.168.1.148:8091/Ajax/userorderlist', //仅为示例，并非真实的接口地址
//   method:'GET',
//   header: {
//       'content-type': 'application/json'
//   },
//   success: function(res) {
//     console.log(res.data)
//   }
// })
    wx.setNavigationBarTitle({
      title: '知行合逸'
    })
  },
  
})

