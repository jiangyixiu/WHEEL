<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<script src="https://www.chazuomba.com/files/webApp/bootstrap/js/jquery.min.js"></script>
		<script>
			var webAppUrlPhp = 'http://api.chazuomba.com/manage/Web/'; //php页面目录
			$(function(){
				//获取code
				var code = request("code");
				if(code){
					getUserInfo(code);
				} else {
					window.location.href = accessPage();
				}
			});

			//截取url参数
			function request(paras){
			    var url = location.href;
			    var paraString = url.substring(url.indexOf("?")+1,url.length).split("&");
			    var paraObj = {};
			    for (var i=0; j=paraString[i]; i++){
			        paraObj[j.substring(0,j.indexOf("=")).toLowerCase()] = j.substring(j.indexOf("=")+1,j.length);
			    }
			    var returnValue = paraObj[paras.toLowerCase()];
			    if(typeof(returnValue)=="undefined"){
			        return "";
			    }else{
			        return returnValue;
			    }
			}
			//若未获取到微信信息，则重新拉取授权
			function accessPage(){
				var authPage = webAppUrlPhp + 'authorize.html?params=' + request('params');
				return 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa3069b403f0a23af&redirect_uri='+ encodeURIComponent(authPage) + '&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect'
			}
			//通过code获取用户unionid
			function getUserInfo(code){
				$.ajax({
				    type: "get",
				    url: "http://api.chazuomba.com/manage/Web/getUserInfoByCode",
				    data: {"code": code},
				    dataType: "json",
				    success: function (data) {
				    	data = data.data;
				        var unionId = data.unionid;
				        var headimgurl = data.headimgurl;
				        var nickname = data.nickname;
				        var openid = data.openid;
				        if(unionId){
							var params = request('params'); //获取页面参数及配置
							params = decodeURIComponent(params);
							params = JSON.parse(params);
							params.unionId = unionId;
							params.nickname = nickname;
							params.avatar = headimgurl;
							params.openid = openid;
							
							var url = params.redirect;
							
							delete params['redirect'];
							params = JSON.stringify(params);
							url += '?params=' + encodeURIComponent(params);
							
							window.location.href = url;
				        } else {
				        	window.location.href = accessPage();
				        }
				    }
				});
			}
			//用法示例
//			var params = {
//				redirect: 'http://www.chazuomba.com/files/webApp/liveplay/index.html',
//				courseId: '1743'
//			};
//			params = JSON.stringify(params);
//			params = encodeURIComponent(params);
//			window.location.href = 'http://api.chazuomba.com/manage/Web/authorize.html?params=' + params;
		</script>
	</head>
	<body>
	</body>
</html>
