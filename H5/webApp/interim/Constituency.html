<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>区域选择</title>
    <link rel="stylesheet" href="/css/reset.css?v=1.0.2">
    <link rel="stylesheet" href="/css/common.css?v=1.0.2">
    <link rel="stylesheet" href="/bootstrap/Font-Awesome/css/font-awesome.min.css">
    <script type="text/javascript" src="/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/main.js?v=1.0.2"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="/js/jquery.qrcode.min.js"></script>
    <style>
        .dcm{
            max-width: 46rem;
            max-height: 66rem;
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            top: 0;
            margin: auto;
        }
        svg text{
            font-family: 'PingFangSC-Regular','microsoft yahei';
            pointer-events: none;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -khtml-user-select: none;
            user-select: none;
        }
        svg{
            width: 100%;
            height: 266px;
            text-align: center;
            margin: 10% auto 0;
        }
        .title{
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.2rem;
            font-family: PingFangSC-Medium,"microsoft yahei";
            color: #FF9999;
        }

        /*二维码*/
        #newQrcode{
            padding-top: 42%;
            position: fixed;
            top: 0;
            z-index: 100000;
            width: 100%;
            height: 100%;
            text-align: center;
            box-sizing: border-box;
            display: none;
        }
        #newQrcode canvas{
            border: 15px solid #FFFFFF;
            background-color: #ffffff;
            /*box-shadow: 0 0 5px 1px rgba(0,0,0,0.2);*/
            position: absolute;
            top: 0%;
            left: 0%;
            right: 0%;
            bottom: 0%;
            margin: auto;
        }
        body{
            padding: 0!important;
        }
        #newQrcode i{
            width: 3.33rem;
            height: 3.33rem;
            position: absolute;
            top: 20%;
            right: 12%;
            font-size: 1.5rem;
            color: #000;
            background: #FFFFFF;
        }
        .pointQR{
            width: 264px;
            height: 60px;
            font-size: 1.66rem;
            color: #333;
            position: absolute;
            padding-top: 310px;
            top: 0%;
            left: 0%;
            right: 0%;
            bottom: 0%;
            margin: auto;
        }
        .btnBox{
            overflow: hidden;
            margin: 0 1.6rem 8rem;
        }
        .btn .yiMan{
            position: absolute;
            right: 0;
            top: 0;
            width: 4.2rem;
            height: 1.4rem;
            line-height: 1.4rem;
            background: url("/images/man.png") no-repeat;
            background-size: 100% 100%;
            color: #FFFFFF;
            font-size: 0.8rem;
            text-align: center;
        }
        .btn{
            width: 46%;
            margin: 0 0.4rem 1rem;
            background: #e1eaf4;
            display: inline-block;
            line-height: 4rem;
            border-radius: 3px;
            padding: 0 1rem;
            box-sizing: border-box;
            font-size: 1.06rem;
            position: relative;
        }
        .btn .qv{
            float: left;
        }
        .btn .price{
            float: right;
        }
        .VIP,.B,.D{
            float: left;
        }
        .A,.C{
            float: right;
        }
    </style>
</head>
<body>
<div id="dcm" class="dcm">
    <svg version="1.1" id="图层_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="773px" height="290px" viewBox="948 247.902 773 595.743" enable-background="new 948 247.902 773 595.743"
	 xml:space="preserve">
    <polygon fill="#F2F2F2" points="1576.301,295.205 1092.697,295.205 991.965,528.271 991.965,649.579 1677.035,649.579
        1677.035,528.271 "/>
    <rect x="1560" y="816.947" fill="#bfbfbf" width="22" height="22"/>
    <text transform="matrix(1 0 0 1 1600 831.073)" font-family="'FZLTCXHJW--GB1-0'" font-size="16">未开放</text>

    <g>
        <path id="VIP" fill="#d3d400" color="#d3d400" d="M1409.666,314.772h-148.344l-22.773,46.455h191.902L1409.666,314.772z M1246.666,402.75h15v-20h-15V402.75
            z"/>
    </g>
    <g>
        <path id="A" fill="#57ce59" color="#57ce59" d="M1526.061,314.772h-63.944l14.675,46.455h80.24L1526.061,314.772z M1111.968,361.227h80.241l14.674-46.455
            h-63.944L1111.968,361.227z M1235.033,370.262l-16.466,33.584v34.186h231.865v-34.186l-15.026-33.584H1235.033z"/>
    </g>
    <g>
        <path id="B" fill="#67a6ff" color="#67a6ff" d="M1060.764,438.032h117.872v-33.838l10.719-33.932h-83.409L1060.764,438.032z M1218.567,534.715h231.865
            v-87.647h-231.865V534.715z M1608.235,438.032l-45.182-67.77h-83.409l10.72,33.932v33.838H1608.235z"/>
    </g>
    <g>
        <path id="C" fill="#946ff7" color="#946ff7" d="M1648.301,548.72l-25.539-88.898l-8.505-12.755h-123.893V638.14h136.556
            C1650.834,615.265,1648.301,548.72,1648.301,548.72z M1046.238,459.822l-25.539,88.898c0,0-2.533,66.545,21.381,89.42h136.557
            V447.067h-123.894L1046.238,459.822z M1218.567,620.464h231.865V543.75h-231.865V620.464z"/>
    </g>
    <g>
        <path id="D" fill="#ff8dbe" color="#ff8dbe" d="M1013.96,790.988h641.08v-93.085h-641.08V790.988z"/>
    </g>


    <polygon fill="#999999" points="1565.434,270.063 1103.563,270.063 1092.698,295.205 1576.302,295.205 "/>

        <text transform="matrix(1 0 0 1 1314.6208 288.6169)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="19.8787">讲台</text>
        <text transform="matrix(1 0 0 1 1318.0613 344.0554)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">VIP</text>
        <text transform="matrix(1 0 0 1 1313.7224 410.4021)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">A 区</text>
        <text transform="matrix(1 0 0 1 1138.6482 344.2546)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">A 区</text>
        <text transform="matrix(1 0 0 1 1488.7966 344.2546)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">A 区</text>
        <text transform="matrix(1 0 0 1 1314.5144 497.1453)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">B 区</text>
        <text transform="matrix(1 0 0 1 1105.075 410.4021)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">B 区</text>
        <text transform="matrix(1 0 0 1 1523.9539 410.4021)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">B 区</text>
        <text transform="matrix(1 0 0 1 1314.0828 588.3621)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">C 区</text>
        <text transform="matrix(1 0 0 1 1079.2126 548.8591)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">C 区</text>
        <text transform="matrix(1 0 0 1 1548.9539 548.8591)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">C 区</text>
        <text transform="matrix(1 0 0 1 1313.1199 750.698)" fill="#FFFFFF" font-family="'MicrosoftYaHei'" font-size="20.7823">D 区</text>
    </svg>

    <div class="title">请选择区域</div>
    <div class="btnBox">
        <ul class="VIP btn" id="vip">
            <li class="qv">VIP区</li>
            <li class="price"></li>
        </ul>
        <ul class="A btn" id="a">
            <li class="qv">A区</li>
            <li class="price"></li>
        </ul>
        <ul class="B btn" id="b">
            <li class="qv">B区</li>
            <li class="price"></li>
        </ul>
        <ul class="C btn" id="c">
            <li class="qv">C区</li>
            <li class="price"></li>
        </ul>
        <ul class="D btn" id="d" style="display:none;">
            <li class="qv">D区（二楼）</li>
            <li class="price"></li>
        </ul>
    </div>
</div>
<div id="enroll">提交选区</div>

<div id="newQrcode"></div>  <!--二维码-->
<script>
    loading(true);
    $('#dcm').hide();
    var courseId;
    var unionid;
    var buySelf = request("buySelf");
    var code = request("code");
    var prefer; //最终选择
    //#f2f2f2 已满
    //#bfbfbf 未开放
    //#e1eaf4 可选择
    //#ff747f 已选择
    if(code){
        $.ajax({
            type: "get",
            url: "http://api.chazuomba.com/manage/Web/getUserInfoByCode",
            data: {"code": code},
            dataType: "json",
            success: function (data) {
                unionid = data.data.unionid;
                console.log(data)
            }
        });
    }else{
        //根据code 取得acces_token 进一步 取得unionid
        var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa3069b403f0a23af&redirect_uri=http://api.chazuomba.com/manage/Web/Constituency.html?buySelf="+buySelf+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect";
        window.location.href = url;
    }

    $.ajax({
        type: "get",
        url: baseUrl + "findAreaInfoForEnlargedClass",
        data: {},
        async: true,
        dataType: "json",
        success: function (data) {
            loading(false);
            $('#dcm').show();
//            console.log("findAreaInfoForEnlargedClass:",data)
            if(data.status == '200'){
                judge(data);
                submit(data.data);
//                console.log("findAreaInfoForEnlargedClass:",data)
            }
        }
    });
    // 是否开放
    function judge(data){
        console.log(data)
        var vipIsOpen = data.data.vipIsOpen;
        var aisOpen = data.data.aisOpen;
        var bisOpen = data.data.bisOpen;
        var cisOpen = data.data.cisOpen;
        var disOpen = data.data.disOpen;

        if(vipIsOpen.indexOf('0') != -1){
            _over($('#VIP'));
            $('.VIP').addClass('openOver');
            $('.VIP').css({"color":"#999",'backgroundColor': '#f2f2f2'});
        }
        if(aisOpen.indexOf('0') != -1){
            _over($('#A'));
            $('.A').addClass('openOver');
            $('.A').css({"color":"#999",'backgroundColor': '#f2f2f2'});
        }
        if(bisOpen.indexOf('0') != -1){
            _over($('#B'));
            $('.B').addClass('openOver');
            $('.B').css({"color":"#999",'backgroundColor': '#f2f2f2'});
        }
        if(cisOpen.indexOf('0') != -1){
            _over($('#C'));
            $('.C').addClass('openOver');
            $('.C').css({"color":"#999",'backgroundColor': '#f2f2f2'});
        }
        if(disOpen.indexOf('0') != -1){
            _over($('#D'));
            $('.D').addClass('openOver');
            $('.D').css({"color":"#999",'backgroundColor': '#f2f2f2'});
        }
        function _over(obj){
            obj.css("fill","#bfbfbf").attr({
                "over": "over",
                "class": "over"
            });
        }
//        console.log("Open:",vipIsOpen,aisOpen,bisOpen,cisOpen,disOpen)
        var judge = vipIsOpen + aisOpen + bisOpen + cisOpen + disOpen;
        if(judge.indexOf('1')!= -1){
            full(data.data)
        }
    }

    //某区已报满
    function full(data){
        var aprice = data.aprice;
        var bprice = data.bprice;
        var cprice = data.cprice;
        var dprice = data.dprice;
        var vPrice = data.vipPrice;
        $('.A .price').html(aprice+'元');
        $('.B .price').html(bprice+'元');
        $('.C .price').html(cprice+'元');
        $('.D .price').html(dprice+'元');
        $('.VIP .price').html(vPrice+'元');


        if(data.aisOver.indexOf('0') == -1){
//            $('.A').addClass('openOver');
            $('.A').addClass('over');
            $('.A').append('<li class="yiMan">已满</li>');
        }
        if(data.bisOver.indexOf('0') == -1){
//            $('.A').addClass('openOver');
            $('.B').addClass('over');
            $('.B').append('<li class="yiMan">已满</li>');
        }
        if(data.cisOver.indexOf('0') == -1){
//            $('.A').addClass('openOver');
            $('.C').addClass('over');
            $('.C').append('<li class="yiMan">已满</li>');
        }
        if(data.disOver.indexOf('0') == -1){
            $('.D').addClass('over');
            $('.D').append('<li class="yiMan">已满</li>');
        }
        if(data.vipIsOver.indexOf('0') == -1){
//            $('.A').addClass('openOver');
            $('.VIP').addClass('over');
            $('.VIP').append('<li class="yiMan">已满</li>');
        }
        //预选择
        $('.over').css({'backgroundColor': '#e1eaf4','color': '#ccc'});
        $('.openOver').css({'backgroundColor': '#f2f2f2','color': '#ccc'});
        $('.btn').on('touchstart',function(){
            if(!$(this).hasClass('over')&&!$(this).hasClass('openOver')){
                $(this).css({
                    'backgroundColor': '#ff747f',
                    'color': '#FFFFFF'
                }).siblings('').css({'backgroundColor': '#e1eaf4','color': '#000'});
                $('.over').css({'backgroundColor': '#e1eaf4','color': '#ccc'});
                $('.openOver').css({'backgroundColor': '#f2f2f2','color': '#ccc'});
                prefer = $(this).attr('id');
            }
            console.log('预选择:',prefer);
        });
    }

    function submit(data){
        //提交区位选择
        $('#enroll').on('click',function(){
            console.log(prefer)
            if(prefer=='a'){
                zhiFuPage(data.aid);
            }else if(prefer=='b'){
                zhiFuPage(data.bid);
            }else if(prefer=='c'){
                zhiFuPage(data.cid);
            }else if(prefer=='d'){
                zhiFuPage(data.did);
            }else if(prefer=='vip'){
                zhiFuPage(data.vipId);
            }
        });
    }

    function zhiFuPage(courseId){
            if(buySelf == '1'){
                $.getJSON(baseUrl + "getIfBuyCourseByUnionid",{
                    'client_version':'1',
                    'device_id':'1',
                    'platform':'web',
                    'type':'1',
                    'unionId': unionid,
                    'courseId': courseId
                }, function(data) {
                    console.log(data);
                    if(data.msg == "未购买"){
//                        var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa3069b403f0a23af&redirect_uri=http://api.chazuomba.com/manage/Web/PaymentPage/courseId/"+courseId+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect";
                        var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa3069b403f0a23af&redirect_uri=http://api.chazuomba.com/manage/Web/PaymentPage/courseId/"+courseId+encodeURIComponent("?buySelf="+buySelf)+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect";

                        window.location.href = url;
                    }else if(data.status == "200"){
                        var url = encodeURI("http://www.chazuomba.com/files/webApp/payment/paySuccess.html?unionId="+ unionid + "&buySelf=" + buySelf);
                        window.location.href = url;
                    }
                });
            }else{
                var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa3069b403f0a23af&redirect_uri=http://api.chazuomba.com/manage/Web/PaymentPage/courseId/"+courseId+encodeURIComponent("?buySelf="+buySelf)+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect";
                window.location.href = url;
            }
//        });


//        var url = "jump.html?courseId="+courseId+"&buySelf="+buySelf;
//        window.location.href = url;

    }
//        // 生成二维码
//        //正服
//        var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa3069b403f0a23af&redirect_uri=http://api.chazuomba.com/manage/Web/PaymentPage/courseId/"+courseId+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect";
//        //测服
//        //var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx1541ccc024a8e057&redirect_uri=http://www.chazuomba.com/files/hehe/webApp/PaymentPage.html?courseId="+courseId+"&response_type=code&scope=snsapi_base&state=123#wechat_redirect";
//
//        // 生成二维码函数
//        function utf16to8(str) {   //二维码包含的内容，默认只支持英文内容,中文会乱码，通过utf16to8转码可支持中文
//            var out, i, len, c;
//            out = "";
//            len = str.length;
//            for (i = 0; i < len; i++) {
//                c = str.charCodeAt(i);
//                if ((c >= 0x0001) && (c <= 0x007F)) {
//                    out += str.charAt(i);
//                } else if (c > 0x07FF) {
//                    out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));
//                    out += String.fromCharCode(0x80 | ((c >> 6) & 0x3F));
//                    out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
//                } else {
//                    out += String.fromCharCode(0xC0 | ((c >> 6) & 0x1F));
//                    out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
//                }
//            }
//            return out;
//        };
//
//        var isWX = isWeiXin();
//        if( !isWX ){
//            huaPing(false);
//            $('#newQrcode').html('<i class="icon-remove"></i><div class="pointQR">请截取二维码<br/>使用微信扫一扫进行支付</div>').show();
//            $('#newQrcode').css({'backgroundColor':'#fff'})
//            // url = (url == "" ? "http://www.zhoou.com" : url);
//            var _url = utf16to8(url);
//
//            jQuery('#newQrcode').qrcode({
//                text: _url,              //设置二维码内容
//                width: 200,             //设置宽度
//                height: 200,            //设置高度
//                correctLevel: 0,        //纠错等级,
//                render: "canvas",       //设置渲染方式
//                background: "#ffffff",  //背景颜色
//                foreground: "#000000"   //前景颜色
//            });
//            $("#newQrcode").on('touchstart',function(){
//                $(this).hide();
//                huaPing(true);
//            });
//        } else {
//            window.location.href = url;
//        }
//    }


    // 是否在微信里
    function isWeiXin(){
        var ua = window.navigator.userAgent.toLowerCase();
        if(ua.match(/MicroMessenger/i) == 'micromessenger'){
            return true;
        }else{
            return false;
        }
    }
</script>
</body>
</html>